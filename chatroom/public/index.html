<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>Secure Chat</title>

        <!-- External Libraries -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

        <style>
            :root {
                --imessage-blue: #007aff;
                --imessage-light-gray: #e5e5ea;
                --imessage-dark-gray: #8e8e93;
                --background-color: #ffffff;
                --message-bg: #f0f0f5;
                --header-bg: #f7f7f7;
                --input-bg: #f7f7f7;
                --text-color: #1d1d1f;
                --border-color: #e5e5ea;
                --shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
                --font-family:
                    -apple-system, BlinkMacSystemFont, "San Francisco",
                    "Helvetica Neue", Helvetica, Arial, sans-serif;
                --privacy-alert: #ff3b30;
                --warning-bg: #fff3cd;
                --warning-border: #ffeaa7;
                --warning-text: #856404;
            }

            [data-theme="dark"] {
                --background-color: #1c1c1e;
                --message-bg: #2c2c2e;
                --header-bg: #1c1c1e;
                --input-bg: #2c2c2e;
                --text-color: #ffffff;
                --border-color: #3a3a3c;
                --imessage-light-gray: #3a3a3c;
                --shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
                --warning-bg: #3a2a1a;
                --warning-border: #6b5b00;
                --warning-text: #ffeb3b;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: var(--font-family);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                margin: 0;
                padding: 10px;
                overflow: hidden;
                color: var(--text-color);
                transition: all 0.3s ease;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }

            [data-theme="dark"] body {
                background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            }

            .container {
                background: var(--background-color);
                border-radius: 20px;
                box-shadow: var(--shadow);
                width: 100%;
                max-width: min(95vw, 740px);
                height: min(95vh, 850px);
                display: flex;
                flex-direction: column;
                overflow: hidden;
                border: 1px solid var(--border-color);
                position: relative;
                animation: containerFadeIn 0.8s cubic-bezier(0.2, 0, 0.2, 1);
                backdrop-filter: blur(10px);
            }

            @keyframes containerFadeIn {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .header {
                background: var(--header-bg);
                padding: 18px 24px;
                text-align: center;
                position: relative;
                border-bottom: 1px solid var(--border-color);
                flex-shrink: 0;
                backdrop-filter: blur(10px);
            }

            .header h1 {
                font-size: 17px;
                font-weight: 600;
                color: var(--text-color);
            }

            .connection-status {
                display: inline-block;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                margin-left: 8px;
                background-color: #34c759;
                animation: pulse 2s infinite;
            }

            .connection-status.disconnected {
                background-color: var(--privacy-alert);
                animation: none;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            .header-controls {
                position: absolute;
                right: 16px;
                top: 50%;
                transform: translateY(-50%);
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .theme-toggle,
            .exit-session-btn {
                background: transparent;
                border: none;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                font-size: 18px;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--imessage-dark-gray);
            }

            .theme-toggle:hover,
            .exit-session-btn:hover {
                background: var(--imessage-light-gray);
                color: var(--text-color);
                transform: scale(1.1);
            }

            .exit-session-btn:hover {
                background: #ffeaea;
                color: var(--privacy-alert);
            }

            .login-screen {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                flex: 1;
                padding: 40px;
                animation: fadeIn 0.5s ease-in-out;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .login-screen h2 {
                font-weight: 600;
                font-size: 28px;
                margin-bottom: 16px;
                color: var(--text-color);
                text-align: center;
            }

            .login-screen p {
                color: var(--imessage-dark-gray);
                margin-bottom: 32px;
                max-width: 400px;
                text-align: center;
                line-height: 1.6;
                font-size: 16px;
            }

            .login-form {
                display: flex;
                flex-direction: column;
                width: 100%;
                max-width: 350px;
                gap: 20px;
            }

            .login-form input {
                padding: 16px 20px;
                border: 2px solid var(--border-color);
                border-radius: 15px;
                font-size: 16px;
                font-family: var(--font-family);
                background: var(--background-color);
                color: var(--text-color);
                transition: all 0.3s ease;
            }

            .login-form input:focus {
                outline: none;
                border-color: var(--imessage-blue);
                box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.15);
                transform: translateY(-2px);
            }

            .login-form button {
                padding: 16px 20px;
                background: linear-gradient(
                    135deg,
                    var(--imessage-blue) 0%,
                    #0056b3 100%
                );
                color: white;
                border: none;
                border-radius: 15px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4);
            }

            .login-form button:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 122, 255, 0.6);
            }

            .login-form button:active {
                transform: translateY(0px);
            }

            .error-message,
            .privacy-alert {
                background: var(--warning-bg);
                border: 2px solid var(--warning-border);
                color: var(--warning-text);
                padding: 15px;
                border-radius: 12px;
                margin-top: 16px;
                font-size: 14px;
                animation: shake 0.5s;
                text-align: center;
                font-weight: 500;
            }

            .privacy-alert {
                background: rgba(255, 59, 48, 0.1);
                border-color: var(--privacy-alert);
                color: var(--privacy-alert);
                animation: privacyAlert 0.6s ease;
            }

            @keyframes shake {
                0%,
                100% {
                    transform: translateX(0);
                }
                25% {
                    transform: translateX(-8px);
                }
                75% {
                    transform: translateX(8px);
                }
            }

            @keyframes privacyAlert {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.05);
                }
            }

            .chat-container {
                display: none;
                flex-direction: column;
                flex: 1;
                min-height: 0;
                background-color: var(--background-color);
                position: relative;
            }

            .user-list {
                font-size: 13px;
                color: var(--imessage-dark-gray);
                text-align: center;
                padding: 10px;
                border-bottom: 1px solid var(--border-color);
                font-weight: 500;
            }

            .typing-indicator {
                font-size: 13px;
                color: var(--imessage-dark-gray);
                text-align: center;
                padding: 8px;
                height: 35px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-style: italic;
            }

            .typing-dots {
                display: inline-flex;
                gap: 3px;
                margin-left: 5px;
            }

            .typing-dots span {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background-color: var(--imessage-dark-gray);
                animation: typing 1.4s infinite;
            }

            .typing-dots span:nth-child(2) {
                animation-delay: 0.2s;
            }
            .typing-dots span:nth-child(3) {
                animation-delay: 0.4s;
            }

            @keyframes typing {
                0%,
                60%,
                100% {
                    transform: translateY(0);
                    opacity: 0.4;
                }
                30% {
                    transform: translateY(-8px);
                    opacity: 1;
                }
            }

            .messages {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 15px;
                background: var(--background-color);
                scroll-behavior: smooth;
            }

            .message {
                display: flex;
                flex-direction: column;
                max-width: 75%;
                word-wrap: break-word;
                animation: messageFadeIn 0.6s ease;
                position: relative;
                margin-bottom: 5px;
            }

            @keyframes messageFadeIn {
                from {
                    opacity: 0;
                    transform: translateY(15px) scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            .message.own {
                align-self: flex-end;
                align-items: flex-end;
            }

            .message.other {
                align-self: flex-start;
                align-items: flex-start;
            }

            .message-username {
                font-size: 12px;
                color: var(--imessage-dark-gray);
                margin: 0 12px 6px;
                font-weight: 600;
            }

            .message.own .message-username {
                display: none;
            }

            .message-bubble {
                padding: 12px 18px;
                border-radius: 22px;
                line-height: 1.4;
                font-size: 16px;
                position: relative;
                cursor: pointer;
                transition: all 0.2s ease;
                max-width: 100%;
                word-break: break-word;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .message-bubble:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .message.own .message-bubble {
                background: linear-gradient(
                    135deg,
                    var(--imessage-blue) 0%,
                    #0056b3 100%
                );
                color: white;
                border-bottom-right-radius: 8px;
            }

            .message.other .message-bubble {
                background: var(--imessage-light-gray);
                color: var(--text-color);
                border-bottom-left-radius: 8px;
            }

            .message-file {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 15px 18px;
                background: var(--message-bg);
                border-radius: 18px;
                border: 2px solid var(--border-color);
                cursor: pointer;
                transition: all 0.3s ease;
                max-width: 300px;
            }

            .message-file:hover {
                background: var(--imessage-light-gray);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .file-icon {
                width: 45px;
                height: 45px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                background: var(--imessage-blue);
                color: white;
                flex-shrink: 0;
            }

            .file-info h4 {
                font-size: 14px;
                font-weight: 600;
                margin-bottom: 4px;
                color: var(--text-color);
            }

            .file-info span {
                font-size: 12px;
                color: var(--imessage-dark-gray);
            }

            .message-image {
                max-width: 280px;
                max-height: 200px;
                border-radius: 15px;
                cursor: pointer;
                transition: all 0.3s ease;
                object-fit: cover;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .message-image:hover {
                transform: scale(1.02);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            }

            .message .timestamp {
                font-size: 11px;
                color: rgba(255, 255, 255, 0.7);
                position: absolute;
                bottom: -18px;
                right: 10px;
                opacity: 0;
                transition: opacity 0.3s ease;
                font-weight: 500;
                background: rgba(0, 0, 0, 0.2);
                padding: 2px 6px;
                border-radius: 8px;
                backdrop-filter: blur(5px);
            }

            .message.other .timestamp {
                color: var(--imessage-dark-gray);
                left: 10px;
                right: auto;
                background: var(--message-bg);
            }

            .message:hover .timestamp {
                opacity: 1;
            }

            .message-reactions {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
                margin-top: 8px;
                margin-left: 12px;
            }

            .message.own .message-reactions {
                margin-left: 0;
                margin-right: 12px;
                justify-content: flex-end;
            }

            .reaction {
                background: var(--message-bg);
                border: 2px solid var(--border-color);
                border-radius: 15px;
                padding: 4px 8px;
                font-size: 12px;
                display: flex;
                align-items: center;
                gap: 4px;
                cursor: pointer;
                transition: all 0.2s ease;
                font-weight: 600;
            }

            .reaction:hover {
                background: var(--imessage-light-gray);
                transform: scale(1.1);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .reaction.active {
                background: var(--imessage-blue);
                color: white;
                border-color: var(--imessage-blue);
            }

            .reaction-picker {
                position: absolute;
                bottom: 110%;
                left: 50%;
                transform: translateX(-50%);
                background: var(--background-color);
                border: 2px solid var(--border-color);
                border-radius: 25px;
                padding: 10px 15px;
                display: none;
                flex-wrap: wrap;
                gap: 8px;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
                z-index: 100;
                backdrop-filter: blur(10px);
            }

            .reaction-picker.show {
                display: flex;
                animation: reactionPickerShow 0.3s ease;
            }

            @keyframes reactionPickerShow {
                from {
                    opacity: 0;
                    transform: translateX(-50%) scale(0.8);
                }
                to {
                    opacity: 1;
                    transform: translateX(-50%) scale(1);
                }
            }

            .reaction-picker span {
                font-size: 24px;
                padding: 8px;
                cursor: pointer;
                border-radius: 12px;
                transition: all 0.2s ease;
            }

            .reaction-picker span:hover {
                background: var(--imessage-light-gray);
                transform: scale(1.2);
            }

            .system-message {
                text-align: center;
                color: var(--imessage-dark-gray);
                font-size: 13px;
                margin: 20px auto;
                padding: 8px 15px;
                background-color: var(--message-bg);
                border-radius: 15px;
                max-width: fit-content;
                font-weight: 500;
                border: 1px solid var(--border-color);
            }

            .privacy-warning {
                background: rgba(255, 59, 48, 0.1);
                color: var(--privacy-alert);
                border: 2px solid var(--privacy-alert);
                animation: privacyAlert 0.6s ease;
                font-weight: 600;
            }

            .input-area {
                display: flex;
                padding: 15px;
                background: var(--input-bg);
                border-top: 1px solid var(--border-color);
                align-items: flex-end;
                gap: 12px;
                backdrop-filter: blur(10px);
            }

            .input-controls {
                display: flex;
                flex-direction: column;
                flex: 1;
                gap: 10px;
            }

            .input-controls input[type="text"] {
                flex: 1;
                padding: 12px 20px;
                border: 2px solid var(--border-color);
                border-radius: 25px;
                font-size: 16px;
                outline: none;
                font-family: var(--font-family);
                background: var(--background-color);
                color: var(--text-color);
                transition: all 0.3s ease;
                resize: none;
            }

            .input-controls input[type="text"]:focus {
                border-color: var(--imessage-blue);
                box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
                transform: translateY(-1px);
            }

            .file-upload-area {
                display: none;
                flex-wrap: wrap;
                gap: 10px;
                padding: 10px 0;
            }

            .file-upload-preview {
                display: flex;
                align-items: center;
                gap: 10px;
                background: var(--message-bg);
                border: 2px solid var(--border-color);
                border-radius: 12px;
                padding: 10px;
                transition: all 0.2s ease;
            }

            .file-upload-preview:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .file-upload-preview img {
                width: 50px;
                height: 50px;
                object-fit: cover;
                border-radius: 8px;
            }

            .file-upload-info {
                flex: 1;
            }

            .file-upload-info h4 {
                font-size: 14px;
                font-weight: 600;
                color: var(--text-color);
                margin-bottom: 2px;
            }

            .file-upload-info span {
                font-size: 12px;
                color: var(--imessage-dark-gray);
            }

            .remove-file {
                background: var(--privacy-alert);
                color: white;
                border: none;
                border-radius: 50%;
                width: 24px;
                height: 24px;
                font-size: 14px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .remove-file:hover {
                transform: scale(1.1);
                background: #d63031;
            }

            .input-buttons {
                display: flex;
                align-items: flex-end;
                gap: 10px;
            }

            .file-input-btn,
            .send-button {
                width: 45px;
                height: 45px;
                border: none;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .file-input-btn {
                background: var(--imessage-light-gray);
                color: var(--imessage-dark-gray);
            }

            .file-input-btn:hover {
                background: var(--imessage-dark-gray);
                color: white;
                transform: scale(1.1);
            }

            .send-button {
                background: linear-gradient(
                    135deg,
                    var(--imessage-blue) 0%,
                    #0056b3 100%
                );
                color: white;
            }

            .send-button:hover:not(:disabled) {
                transform: scale(1.1);
                box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4);
            }

            .send-button:active {
                transform: scale(0.95);
            }

            .send-button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }

            #fileInput {
                display: none;
            }

            /* Image Modal */
            .image-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.95);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                padding: 20px;
                backdrop-filter: blur(5px);
            }

            .image-modal.show {
                animation: modalFadeIn 0.3s ease;
            }

            @keyframes modalFadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            .image-modal img {
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                border-radius: 10px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            }

            .image-modal-close {
                position: absolute;
                top: 30px;
                right: 30px;
                background: rgba(255, 255, 255, 0.2);
                color: white;
                border: none;
                border-radius: 50%;
                width: 50px;
                height: 50px;
                font-size: 24px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                backdrop-filter: blur(10px);
            }

            .image-modal-close:hover {
                background: rgba(255, 255, 255, 0.3);
                transform: scale(1.1);
            }

            /* Privacy Alert Overlay */
            .privacy-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(255, 59, 48, 0.95);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 2000;
                backdrop-filter: blur(10px);
            }

            .privacy-overlay.show {
                animation: privacyOverlayShow 0.5s ease;
            }

            @keyframes privacyOverlayShow {
                from {
                    opacity: 0;
                    transform: scale(0.8);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .privacy-overlay-content {
                background: white;
                border-radius: 20px;
                padding: 40px;
                text-align: center;
                max-width: 400px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            }

            .privacy-overlay-content h2 {
                color: var(--privacy-alert);
                font-size: 24px;
                margin-bottom: 20px;
            }

            .privacy-overlay-content p {
                color: #333;
                font-size: 16px;
                line-height: 1.6;
                margin-bottom: 20px;
            }

            .privacy-overlay-content button {
                background: var(--privacy-alert);
                color: white;
                border: none;
                border-radius: 10px;
                padding: 12px 25px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .privacy-overlay-content button:hover {
                background: #d63031;
                transform: translateY(-1px);
            }

            /* Responsive Design */
            @media (max-width: 600px) {
                .container {
                    width: 100vw;
                    height: 100vh;
                    border-radius: 0;
                    border: none;
                    max-width: none;
                    max-height: none;
                }

                .header,
                .input-area {
                    padding: 12px;
                }

                .messages {
                    padding: 15px;
                }

                .login-screen {
                    padding: 20px;
                }

                .login-form {
                    max-width: 100%;
                }

                .message-bubble {
                    font-size: 15px;
                    padding: 10px 15px;
                }

                .file-input-btn,
                .send-button {
                    width: 40px;
                    height: 40px;
                    font-size: 18px;
                }

                .header-controls {
                    right: 10px;
                }

                .theme-toggle,
                .exit-session-btn {
                    width: 32px;
                    height: 32px;
                    font-size: 16px;
                }
            }

            @media (max-width: 400px) {
                .header h1 {
                    font-size: 15px;
                }

                .message {
                    max-width: 85%;
                }

                .message-bubble {
                    font-size: 14px;
                }
            }

            /* Notification */
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--background-color);
                border: 2px solid var(--border-color);
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
                z-index: 1001;
                animation: slideIn 0.4s ease;
                max-width: 350px;
                backdrop-filter: blur(10px);
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            .notification h4 {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 6px;
                color: var(--text-color);
            }

            .notification p {
                font-size: 14px;
                color: var(--imessage-dark-gray);
                line-height: 1.4;
            }
        </style>
    </head>

    <body data-theme="light">
        <div class="container">
            <div class="header">
                <h1 id="chat-header">
                    Welcome
                    <span
                        class="connection-status"
                        id="connectionStatus"
                    ></span>
                </h1>
                <div class="user-list" id="userList"></div>
                <div class="typing-indicator" id="typingIndicator"></div>
                <div class="header-controls">
                    <button
                        id="themeToggle"
                        class="theme-toggle"
                        title="Toggle Dark Mode"
                    >
                        üåô
                    </button>
                    <button
                        id="exitSessionBtn"
                        class="exit-session-btn"
                        title="Exit Session"
                    >
                        √ó
                    </button>
                </div>
            </div>

            <div class="login-screen" id="loginScreen">
                <h2>üîê Secure Chat</h2>
                <p>
                    Enter a username and a shared secret key to start your
                    encrypted conversation.
                    <br /><strong>Privacy Protected:</strong> Screenshots and
                    recordings are monitored.
                </p>
                <form class="login-form" id="loginForm">
                    <input
                        type="text"
                        id="usernameInput"
                        placeholder="Username"
                        required
                        autocomplete="off"
                        maxlength="20"
                    />
                    <input
                        type="password"
                        id="secretKeyInput"
                        placeholder="Shared Secret Key"
                        required
                    />
                    <button type="submit">üöÄ Join Secure Chat</button>
                </form>
                <div
                    id="errorMessage"
                    class="error-message"
                    style="display: none"
                ></div>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="messages" id="messages"></div>
                <form class="input-area" id="messageForm">
                    <div class="input-controls">
                        <input
                            type="text"
                            id="messageInput"
                            placeholder="Type your message..."
                            autocomplete="off"
                        />
                        <div class="file-upload-area" id="fileUploadArea"></div>
                    </div>
                    <div class="input-buttons">
                        <input
                            type="file"
                            id="fileInput"
                            accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt"
                        />
                        <button
                            type="button"
                            class="file-input-btn"
                            id="fileInputBtn"
                            title="Upload File"
                        >
                            üìé
                        </button>
                        <button type="submit" class="send-button" id="sendBtn">
                            ‚Üë
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Image Modal -->
        <div class="image-modal" id="imageModal">
            <button class="image-modal-close" id="imageModalClose">√ó</button>
            <img id="imageModalContent" src="" alt="Full size image" />
        </div>

        <!-- Privacy Alert Overlay -->
        <div class="privacy-overlay" id="privacyOverlay">
            <div class="privacy-overlay-content">
                <h2>üö® Privacy Alert</h2>
                <p id="privacyMessage">Suspicious activity detected!</p>
                <button onclick="closePrivacyAlert()">I Understand</button>
            </div>
        </div>

        <!-- Audio for notifications -->
        <audio id="notificationSound" preload="auto">
            <source
                src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmgeBDGH0fPTgjMGHm7A7+OZSR0PVqXh8bllHgg2jdXzzn0vBSl+zPLaizsIGGS57+OdTgwOUarm7blmHgU5k9n1unAiByl8yPDed0ECCFSD1O+sdRIJSI7Y9MF5LQUme8vz1YU2Bypp3O23VwgJL4DN8dqLQAoUXLLn6qdTEwpEneHzvmgfBDWJ1PTQfzEHJHfH8N2QQAoUXrTp66hVFApGn+DyvmgeBDGH0fPTgjMGHm7A7+OZSR0PVqXh8bllHgg2jdXzzn0vBSl+zPLaizsIGGS57+OdTgwOUarm7blmHgU5k9n1unAiByl8yPDed0ECCFSD1O+sdRIJSI7Y9MF5LQUme8vz1YU2Bypp3O23VwgJL4DN8dqLQAoUXLLn6qdTEwpEneHzvmgfBDWJ1PTQfzEHJHfH8N2QQAoUXrTp66hVFApGn+DyvmgeBDGH0fPTgjMGHm7A7+OZSR0PVqXh8bllHgg2jdXzzn0vBSl+zPLaizsIGGS57+OdTgwOUarm7blmHgU5k9n1unAiByl8yPDed0ECCFSD1O+sdRIJSI7Y9MF5LQUme8vz1YU2Bypp3O23VwgJL4DN8dqLQAoUXLLn6qdTEwpEneHzvmgfBDWJ1PTQfzEHJHfH8N2QQAoUXrTp66hVFApGn+DyvmgeBDGH0fPTgjMGHm7A7+OZSR0PVqXh8bllHgg2jdXzzn0vBSl+zPLaizsIGGS57+OdTgwOUarm7blmHgU5k9n1unAiByl8yPDed0ECCFSD1O+sdRIJSI7Y9MF5LQUme8vz1YU2Bypp3O23VwgJL4DN8dqLQAoUXLLn6qdTEwpEneHzvmgfBDWJ1PTQfzEHJHfH8N2QQAoUXrTp66hVFApGn+DyvmgeBDGH0fPTgjMGHm7A7+OZSR0PVqXh8bllHgg2jdXzzn0vBSl+zPLaizsIGGS57+OdTgwOUarm7blmHgU5k9n1unAiByl8yPDed0ECCFSD1O+sdRIJSI7Y9MF5LQUme8vz1YU2Bypp3O23VwgJL4DN8dqLQAoUXLLn6qdTEwpEneHzvmgfBDWJ1PTQfzEHJHfH8N2QQAoUXrTp66hVFApGn+DyvmgeBDGH0fPTgjMGHm7A7+OZSR0PVqXh8bllHgg2jdXzzn0vBSl+zPLaizsIGGS57+OdTgwOUarm7blmHgU5k9n1unAiByl8yPDed0ECCFSD1O+sdRIJSI7Y9MF5LQUme8vz1YU2Bypp3O23VwgJL4DN8dqLQAoUXLLn6qdTEwpEneHzvmgfBDWJ1PTQfzEHJHfH8N2QQAoUXrTp66hVFApGn+DyvmgeBDGH0fPTgjMGHm7A7+OZSR0PVqXh8bllHgg2jdXzzn0vBSl+zPLaizsIGGS57+OdTgwOUarm7blmHgU5k9n1unAiByl8yPDed0ECCFSD1O+sdRIJSI7Y9MF5LQUme8vz1YU2Bypp3O23VwgJL4DN8dqLQAoUXLLn6qdTEwpEneHzvmgfBDWJ1PTQfzEHJHfH8N2QQAoUXrTp66hVFApGn+DyvmgeBDGH0fPTgjMGHm7A7+OZSR0PVqXh8bllHgg2jdXzzn0vBSl+zPLaizsIGGS57+OdTgwOUarm7blmHgU5k9n1unAiByl8yPDed0ECCFSD1O+sdRIJSI7Y9MF5LQUme8vz1YU2Bypp3O23VwgJL4DN8dqLQAoUXLLn6qdTEwpEneHzvmgfBDWJ1PTQfzEHJHfH8N2QQAoUXrTp66hVFApGn+Dyvmg"
            />
        </audio>

        <script>
            // Global variables
            let socket;
            let currentUser = "";
            let secretKey = "";
            let currentRoom = "";
            let typingTimeout;
            let currentTheme = localStorage.getItem("theme") || "light";
            let soundEnabled = localStorage.getItem("soundEnabled") !== "false";
            let pendingFiles = [];
            let messageReactions = new Map();
            let lastActivity = Date.now();
            let privacyAlerts = [];
            let isDevToolsOpen = false;
            let screenshotCount = 0;
            let screenRecordingActive = false;

            // DOM Elements
            const loginForm = document.getElementById("loginForm");
            const messageForm = document.getElementById("messageForm");
            const usernameInput = document.getElementById("usernameInput");
            const secretKeyInput = document.getElementById("secretKeyInput");
            const messageInput = document.getElementById("messageInput");
            const loginScreen = document.getElementById("loginScreen");
            const chatContainer = document.getElementById("chatContainer");
            const messagesContainer = document.getElementById("messages");
            const chatHeader = document.getElementById("chat-header");
            const userList = document.getElementById("userList");
            const typingIndicator = document.getElementById("typingIndicator");
            const exitSessionBtn = document.getElementById("exitSessionBtn");
            const themeToggle = document.getElementById("themeToggle");
            const connectionStatus =
                document.getElementById("connectionStatus");
            const errorMessage = document.getElementById("errorMessage");
            const fileInput = document.getElementById("fileInput");
            const fileInputBtn = document.getElementById("fileInputBtn");
            const fileUploadArea = document.getElementById("fileUploadArea");
            const sendBtn = document.getElementById("sendBtn");
            const notificationSound =
                document.getElementById("notificationSound");
            const imageModal = document.getElementById("imageModal");
            const imageModalContent =
                document.getElementById("imageModalContent");
            const imageModalClose = document.getElementById("imageModalClose");
            const privacyOverlay = document.getElementById("privacyOverlay");

            // Initialize theme
            document.body.setAttribute("data-theme", currentTheme);
            themeToggle.textContent = currentTheme === "dark" ? "‚òÄÔ∏è" : "üåô";

            // Privacy Protection Functions
            const showPrivacyAlert = (message, type = "warning") => {
                const privacyMessage =
                    document.getElementById("privacyMessage");
                privacyMessage.textContent = message;
                privacyOverlay.classList.add("show");
                privacyOverlay.style.display = "flex";

                // Notify other users
                if (socket && socket.connected) {
                    socket.emit("privacy_violation", {
                        type: type,
                        message: `${currentUser} ${message}`,
                        timestamp: new Date().toISOString(),
                    });
                }

                setTimeout(() => {
                    privacyOverlay.classList.remove("show");
                    setTimeout(() => {
                        privacyOverlay.style.display = "none";
                    }, 300);
                }, 3000);
            };

            const closePrivacyAlert = () => {
                privacyOverlay.classList.remove("show");
                setTimeout(() => {
                    privacyOverlay.style.display = "none";
                }, 300);
            };

            // Screenshot Detection
            const detectScreenshot = () => {
                let lastVisibilityChange = Date.now();

                document.addEventListener("visibilitychange", () => {
                    const now = Date.now();
                    if (document.hidden && now - lastVisibilityChange < 100) {
                        screenshotCount++;
                        showPrivacyAlert(
                            `üì∏ Screenshot detected! (${screenshotCount})`,
                            "screenshot",
                        );
                        addPrivacyWarning(
                            "Someone may have taken a screenshot",
                        );
                    }
                    lastVisibilityChange = now;
                });

                // Keyboard shortcut detection
                document.addEventListener("keydown", (e) => {
                    const isScreenshot =
                        (e.metaKey &&
                            e.shiftKey &&
                            (e.key === "3" || e.key === "4")) || // Mac
                        e.key === "PrintScreen" || // Windows/Linux
                        (e.altKey && e.key === "PrintScreen") || // Windows Alt+PrtSc
                        (e.metaKey && e.shiftKey && e.key === "S"); // Some screenshot tools

                    if (isScreenshot) {
                        e.preventDefault();
                        screenshotCount++;
                        showPrivacyAlert(
                            `üì∏ Screenshot attempt blocked! (${screenshotCount})`,
                            "screenshot",
                        );
                        addPrivacyWarning(
                            "Screenshot attempt was detected and blocked",
                        );
                    }
                });
            };

            // Screen Recording Detection
            const detectScreenRecording = async () => {
                try {
                    // Check for screen capture API usage
                    if (
                        navigator.mediaDevices &&
                        navigator.mediaDevices.getDisplayMedia
                    ) {
                        const originalGetDisplayMedia =
                            navigator.mediaDevices.getDisplayMedia;
                        navigator.mediaDevices.getDisplayMedia = function (
                            ...args
                        ) {
                            screenRecordingActive = true;
                            showPrivacyAlert(
                                "üé• Screen recording detected!",
                                "recording",
                            );
                            addPrivacyWarning(
                                "Screen recording activity detected",
                            );
                            return originalGetDisplayMedia.apply(this, args);
                        };
                    }

                    // Monitor for WebRTC screen sharing
                    const originalGetUserMedia =
                        navigator.mediaDevices.getUserMedia;
                    navigator.mediaDevices.getUserMedia = function (
                        constraints,
                    ) {
                        if (
                            constraints &&
                            constraints.video &&
                            constraints.video.mediaSource
                        ) {
                            screenRecordingActive = true;
                            showPrivacyAlert(
                                "üé• Screen capture detected!",
                                "recording",
                            );
                            addPrivacyWarning(
                                "Screen capture activity detected",
                            );
                        }
                        return originalGetUserMedia.apply(this, arguments);
                    };
                } catch (error) {
                    console.log(
                        "Screen recording detection setup failed:",
                        error,
                    );
                }
            };

            // Developer Tools Detection
            const detectDevTools = () => {
                setInterval(() => {
                    const threshold = 160;
                    const isDevToolsOpen =
                        window.outerHeight - window.innerHeight > threshold ||
                        window.outerWidth - window.innerWidth > threshold;

                    if (isDevToolsOpen && !window.isDevToolsAlerted) {
                        window.isDevToolsAlerted = true;
                        showPrivacyAlert(
                            "üõ†Ô∏è Developer tools detected!",
                            "devtools",
                        );
                        addPrivacyWarning("Developer tools were opened");

                        setTimeout(() => {
                            window.isDevToolsAlerted = false;
                        }, 5000);
                    }
                }, 1000);

                // Console detection
                let devtools = { open: false };
                setInterval(() => {
                    if (devtools.open) return;
                    const before = Date.now();
                    console.clear();
                    const after = Date.now();
                    if (after - before > 100) {
                        devtools.open = true;
                        showPrivacyAlert(
                            "üõ†Ô∏è Console access detected!",
                            "console",
                        );
                        addPrivacyWarning("Browser console was accessed");
                    }
                }, 2000);
            };

            // Copy/Paste Detection
            const detectCopyPaste = () => {
                document.addEventListener("copy", (e) => {
                    if (
                        messagesContainer.contains(e.target) ||
                        e.target.closest(".message")
                    ) {
                        e.preventDefault();
                        showPrivacyAlert("üìã Message copying blocked!", "copy");
                        addPrivacyWarning(
                            "Attempt to copy message was blocked",
                        );
                    }
                });

                document.addEventListener("paste", (e) => {
                    if (e.target !== messageInput) {
                        console.log(
                            "Paste attempt detected outside message input",
                        );
                    }
                });

                // Disable right-click context menu on messages
                messagesContainer.addEventListener("contextmenu", (e) => {
                    if (e.target.closest(".message")) {
                        e.preventDefault();
                        showPrivacyAlert(
                            "üñ±Ô∏è Context menu blocked on messages!",
                            "rightclick",
                        );
                        addPrivacyWarning("Right-click blocked on message");
                    }
                });
            };

            // Add privacy warning to chat
            const addPrivacyWarning = (message) => {
                const warningEl = document.createElement("div");
                warningEl.classList.add("system-message", "privacy-warning");
                warningEl.innerHTML = `üîí Privacy Alert: ${message}`;
                messagesContainer.appendChild(warningEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };

            // Encryption Functions (Fixed)
            const encryptMessage = (text) => {
                if (!secretKey) return text;
                try {
                    return CryptoJS.AES.encrypt(text, secretKey).toString();
                } catch (error) {
                    console.error("Encryption error:", error);
                    return text;
                }
            };

            const decryptMessage = (ciphertext) => {
                if (!secretKey) return "‚ö†Ô∏è Missing secret key";
                try {
                    const bytes = CryptoJS.AES.decrypt(ciphertext, secretKey);
                    const originalText = bytes.toString(CryptoJS.enc.Utf8);
                    if (!originalText) {
                        return "‚ö†Ô∏è Could not decrypt message (Wrong Key)";
                    }
                    return originalText;
                } catch (e) {
                    console.error("Decryption error:", e);
                    return "‚ö†Ô∏è Could not decrypt message";
                }
            };

            // Utility Functions
            const showError = (message) => {
                errorMessage.textContent = message;
                errorMessage.style.display = "block";
                setTimeout(() => {
                    errorMessage.style.display = "none";
                }, 5000);
            };

            const updateConnectionStatus = (connected) => {
                if (connectionStatus) {
                    connectionStatus.classList.toggle(
                        "disconnected",
                        !connected,
                    );
                }
            };

            const playNotificationSound = () => {
                if (soundEnabled && notificationSound) {
                    notificationSound.currentTime = 0;
                    notificationSound
                        .play()
                        .catch((e) =>
                            console.log("Could not play notification sound"),
                        );
                }
            };

            const showNotification = (title, body) => {
                if (
                    "Notification" in window &&
                    Notification.permission === "granted"
                ) {
                    new Notification(title, { body, icon: "/favicon.ico" });
                } else {
                    const notification = document.createElement("div");
                    notification.className = "notification";
                    notification.innerHTML = `<h4>${title}</h4><p>${body}</p>`;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 4000);
                }
            };

            const formatFileSize = (bytes) => {
                const sizes = ["Bytes", "KB", "MB", "GB"];
                if (bytes === 0) return "0 Bytes";
                const i = Math.floor(Math.log(bytes) / Math.log(1024));
                return (
                    Math.round((bytes / Math.pow(1024, i)) * 100) / 100 +
                    " " +
                    sizes[i]
                );
            };

            const getFileIcon = (mimetype) => {
                if (mimetype.startsWith("image/")) return "üñºÔ∏è";
                if (mimetype.startsWith("video/")) return "üé•";
                if (mimetype.startsWith("audio/")) return "üéµ";
                if (mimetype.includes("pdf")) return "üìÑ";
                if (mimetype.includes("doc") || mimetype.includes("txt"))
                    return "üìù";
                return "üìé";
            };

            const sanitizeHtml = (text) => {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            };

            const updateActivity = () => {
                lastActivity = Date.now();
                if (socket && socket.connected) {
                    socket.emit("user_activity");
                }
            };

            // Socket Functions
            const initializeSocket = () => {
                try {
                    socket = io(window.location.origin, {
                        timeout: 10000,
                        transports: ["polling", "websocket"],
                        forceNew: true,
                        reconnection: true,
                        reconnectionDelay: 1000,
                        reconnectionDelayMax: 5000,
                        maxReconnectionAttempts: 5,
                        upgrade: true,
                    });
                    setupSocketEvents();
                } catch (error) {
                    console.error("Socket connection failed:", error);
                    showError(
                        "Could not connect to the server. Please check your connection and try again.",
                    );
                }
            };

            const setupSocketEvents = () => {
                socket.on("connect", () => {
                    console.log("Connected to server.");
                    updateConnectionStatus(true);
                    showNotification(
                        "Connected",
                        "Successfully connected to chat server",
                    );

                    // Join room with retry logic
                    const joinData = {
                        username: currentUser,
                        secretKey: secretKey,
                    };
                    socket.emit("join", joinData);

                    // Retry join if no response within 3 seconds
                    setTimeout(() => {
                        if (!currentRoom) {
                            console.log("Retrying join...");
                            socket.emit("join", joinData);
                        }
                    }, 3000);
                });

                socket.on("disconnect", (reason) => {
                    console.log("Disconnected from server:", reason);
                    updateConnectionStatus(false);
                    addSystemMessage(
                        `Disconnected: ${reason}. Reconnecting...`,
                    );
                    showNotification(
                        "Disconnected",
                        "Connection lost. Attempting to reconnect...",
                    );
                });

                socket.on("connect_error", (error) => {
                    console.error("Connection error:", error);
                    updateConnectionStatus(false);
                    showError(
                        `Connection failed: ${error.message || "Network error"}. Please check your internet connection.`,
                    );
                });

                socket.on("error", (data) => {
                    console.error("Server error:", data);
                    showError(data.message || "An error occurred");
                });

                socket.on("join_success", (data) => {
                    currentRoom = data.room;
                    chatHeader.innerHTML = `üíï ${currentUser}'s Secure Chat <span class="connection-status" id="connectionStatus"></span>`;
                    updateUserList(data.users);
                    messageInput.focus();

                    // Update connection status element reference
                    setTimeout(() => {
                        const newConnectionStatus =
                            document.getElementById("connectionStatus");
                        if (newConnectionStatus) {
                            updateConnectionStatus(true);
                        }
                    }, 100);
                });

                socket.on("message_history", (messages) => {
                    messages.forEach((msg) => {
                        const decryptedContent =
                            msg.username === currentUser
                                ? msg.content
                                : decryptMessage(msg.content);
                        displayMessage(
                            {
                                ...msg,
                                content: decryptedContent,
                            },
                            msg.username === currentUser ? "own" : "other",
                        );
                    });
                });

                socket.on("user_joined", (data) => {
                    addSystemMessage(`${data.username} has joined the chat.`);
                    updateUserList(data.users);
                    playNotificationSound();
                });

                socket.on("user_left", (data) => {
                    addSystemMessage(`${data.username} has left the chat.`);
                    updateUserList(data.users);
                });

                socket.on("message", (data) => {
                    // Only display messages from other users
                    if (data.username && data.username !== currentUser) {
                        const decryptedContent = decryptMessage(data.content);
                        displayMessage(
                            {
                                ...data,
                                content: decryptedContent,
                            },
                            "other",
                        );
                        playNotificationSound();

                        if (document.hidden) {
                            showNotification(
                                `${data.username}`,
                                decryptedContent.substring(0, 100),
                            );
                        }
                    }
                });

                socket.on("message_sent", (data) => {
                    // Update message status for own messages
                    const messageEl = document.querySelector(
                        `[data-message-id="${data.id}"]`,
                    );
                    if (messageEl) {
                        messageEl.classList.add("delivered");
                    }
                });

                socket.on("user_typing", (data) => {
                    if (data.username !== currentUser) {
                        showTypingIndicator(data.username);
                    }
                });

                socket.on("stop_typing", (data) => {
                    if (data.username !== currentUser) {
                        hideTypingIndicator();
                    }
                });

                socket.on("reaction_update", (data) => {
                    updateMessageReactions(data.messageId, data.reactions);
                });

                socket.on("privacy_violation", (data) => {
                    addPrivacyWarning(`${data.message}`);
                    playNotificationSound();
                });
            };

            // Message Functions (Fixed)
            const sendMessage = (content, type = "text") => {
                if (!content || !socket || !socket.connected) {
                    showError("Not connected to server. Please try again.");
                    return;
                }

                updateActivity();
                const encryptedContent = encryptMessage(content);
                const messageId = generateMessageId();
                const messageData = {
                    id: messageId,
                    content: encryptedContent,
                    type: type,
                };

                // Display own message immediately with pending status
                displayMessage(
                    {
                        id: messageId,
                        username: currentUser,
                        content: content, // Show original content for own messages
                        type: type,
                        timestamp: new Date().toISOString(),
                        reactions: {},
                        status: "sending",
                    },
                    "own",
                );

                // Send message to server
                socket.emit("message", messageData);
                socket.emit("stop_typing");
            };

            const generateMessageId = () => {
                return (
                    Date.now().toString(36) +
                    Math.random().toString(36).substr(2)
                );
            };

            const displayMessage = (data, type) => {
                const messageEl = document.createElement("div");
                messageEl.classList.add("message", type);
                messageEl.setAttribute(
                    "data-message-id",
                    data.id || generateMessageId(),
                );

                const time = new Date(data.timestamp).toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                });

                const username =
                    type === "own"
                        ? ""
                        : `<div class="message-username">${sanitizeHtml(data.username)}</div>`;
                let messageContent = "";

                if (data.type === "file") {
                    try {
                        const fileData = JSON.parse(data.content);
                        if (
                            fileData.mimetype &&
                            fileData.mimetype.startsWith("image/")
                        ) {
                            messageContent = `<img src="${fileData.url}" class="message-image" alt="${sanitizeHtml(fileData.originalname)}" onclick="openImageModal('${fileData.url}')">`;
                        } else {
                            messageContent = `
                            <div class="message-file" onclick="window.open('${fileData.url}', '_blank')">
                                <div class="file-icon">${getFileIcon(fileData.mimetype)}</div>
                                <div class="file-info">
                                    <h4>${sanitizeHtml(fileData.originalname)}</h4>
                                    <span>${formatFileSize(fileData.size)}</span>
                                </div>
                            </div>`;
                        }
                    } catch (e) {
                        messageContent = `<div class="message-bubble">üìÅ File attachment</div>`;
                    }
                } else {
                    messageContent = `<div class="message-bubble">${sanitizeHtml(data.content || "")}</div>`;
                }

                messageEl.innerHTML = `
                ${username}
                ${messageContent}
                <div class="timestamp">${time}</div>
                <div class="reaction-picker" id="reaction-picker-${data.id}">
                    <span onclick="addReaction('${data.id}', '‚ù§Ô∏è')">‚ù§Ô∏è</span>
                    <span onclick="addReaction('${data.id}', 'üòÇ')">üòÇ</span>
                    <span onclick="addReaction('${data.id}', 'üëç')">üëç</span>
                    <span onclick="addReaction('${data.id}', 'üòÆ')">üòÆ</span>
                    <span onclick="addReaction('${data.id}', 'üò¢')">üò¢</span>
                    <span onclick="addReaction('${data.id}', 'üò°')">üò°</span>
                </div>
                <div class="message-reactions" id="reactions-${data.id}"></div>
            `;

                // Add reaction on double tap/click
                messageEl.addEventListener("dblclick", () => {
                    toggleReactionPicker(data.id);
                });

                messagesContainer.appendChild(messageEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // Update reactions if they exist
                if (data.reactions) {
                    updateMessageReactions(data.id, data.reactions);
                }
            };

            const addSystemMessage = (text) => {
                const systemMessage = document.createElement("div");
                systemMessage.classList.add("system-message");
                systemMessage.textContent = text;
                messagesContainer.appendChild(systemMessage);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };

            const updateUserList = (users) => {
                if (users && users.length > 0) {
                    const userNames = users.map((user) =>
                        typeof user === "string" ? user : user.username,
                    );
                    userList.textContent = `üíö Online: ${userNames.join(", ")}`;
                } else {
                    userList.textContent = "";
                }
            };

            const showTypingIndicator = (username) => {
                typingIndicator.innerHTML = `${sanitizeHtml(username)} is typing <span class="typing-dots"><span></span><span></span><span></span></span>`;
            };

            const hideTypingIndicator = () => {
                typingIndicator.textContent = "";
            };

            // File Upload Functions
            const handleFileSelect = (files) => {
                Array.from(files).forEach((file) => {
                    if (file.size > 10 * 1024 * 1024) {
                        showError(
                            `File "${file.name}" is too large. Maximum size is 10MB.`,
                        );
                        return;
                    }

                    pendingFiles.push(file);
                    displayFilePreview(file);
                });

                fileUploadArea.style.display =
                    pendingFiles.length > 0 ? "flex" : "none";
                updateSendButton();
            };

            const displayFilePreview = (file) => {
                const preview = document.createElement("div");
                preview.className = "file-upload-preview";
                preview.setAttribute("data-filename", file.name);

                let filePreview = `<div class="file-icon">${getFileIcon(file.type)}</div>`;

                if (file.type.startsWith("image/")) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img =
                            preview.querySelector("img") ||
                            document.createElement("img");
                        img.src = e.target.result;
                        if (!preview.querySelector("img")) {
                            preview.insertBefore(img, preview.firstChild);
                        }
                    };
                    reader.readAsDataURL(file);
                    filePreview =
                        '<img style="width:50px;height:50px;object-fit:cover;border-radius:8px;">';
                }

                preview.innerHTML = `
                ${filePreview}
                <div class="file-upload-info">
                    <h4>${sanitizeHtml(file.name)}</h4>
                    <span>${formatFileSize(file.size)}</span>
                </div>
                <button class="remove-file" onclick="removeFile('${file.name}')">√ó</button>
            `;

                fileUploadArea.appendChild(preview);
            };

            const removeFile = (filename) => {
                pendingFiles = pendingFiles.filter(
                    (file) => file.name !== filename,
                );
                const preview = fileUploadArea.querySelector(
                    `[data-filename="${filename}"]`,
                );
                if (preview) preview.remove();

                fileUploadArea.style.display =
                    pendingFiles.length > 0 ? "flex" : "none";
                updateSendButton();
            };

            const uploadFile = async (file) => {
                const formData = new FormData();
                formData.append("file", file);

                try {
                    const response = await fetch("/upload", {
                        method: "POST",
                        body: formData,
                    });

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const fileData = await response.json();
                    return fileData;
                } catch (error) {
                    console.error("File upload error:", error);
                    showError(
                        `Failed to upload "${file.name}". Please try again.`,
                    );
                    return null;
                }
            };

            const sendFiles = async () => {
                for (const file of pendingFiles) {
                    const fileData = await uploadFile(file);
                    if (fileData) {
                        sendMessage(JSON.stringify(fileData), "file");
                    }
                }

                pendingFiles = [];
                fileUploadArea.innerHTML = "";
                fileUploadArea.style.display = "none";
                updateSendButton();
            };

            const updateSendButton = () => {
                const hasContent =
                    messageInput.value.trim() || pendingFiles.length > 0;
                sendBtn.disabled = !hasContent;
            };

            // Reaction Functions
            const toggleReactionPicker = (messageId) => {
                const picker = document.getElementById(
                    `reaction-picker-${messageId}`,
                );
                if (picker) {
                    const isShown = picker.classList.contains("show");

                    // Hide all other pickers
                    document
                        .querySelectorAll(".reaction-picker.show")
                        .forEach((p) => {
                            p.classList.remove("show");
                        });

                    if (!isShown) {
                        picker.classList.add("show");
                        setTimeout(() => picker.classList.remove("show"), 3000);
                    }
                }
            };

            const addReaction = (messageId, emoji) => {
                if (socket && socket.connected) {
                    socket.emit("reaction", {
                        messageId: messageId,
                        emoji: emoji,
                    });
                }

                // Hide reaction picker
                const picker = document.getElementById(
                    `reaction-picker-${messageId}`,
                );
                if (picker) picker.classList.remove("show");
            };

            const updateMessageReactions = (messageId, reactions) => {
                const reactionsContainer = document.getElementById(
                    `reactions-${messageId}`,
                );
                if (!reactionsContainer) return;

                reactionsContainer.innerHTML = "";

                Object.entries(reactions).forEach(([emoji, users]) => {
                    if (users.length > 0) {
                        const reaction = document.createElement("div");
                        reaction.className = "reaction";
                        if (users.includes(currentUser)) {
                            reaction.classList.add("active");
                        }
                        reaction.innerHTML = `${emoji} ${users.length}`;
                        reaction.onclick = () => addReaction(messageId, emoji);
                        reactionsContainer.appendChild(reaction);
                    }
                });
            };

            // Theme Functions
            const toggleTheme = () => {
                currentTheme = currentTheme === "light" ? "dark" : "light";
                document.body.setAttribute("data-theme", currentTheme);
                themeToggle.textContent = currentTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
                localStorage.setItem("theme", currentTheme);
            };

            // Image Modal Functions
            const openImageModal = (src) => {
                imageModalContent.src = src;
                imageModal.classList.add("show");
                imageModal.style.display = "flex";
                document.body.style.overflow = "hidden";
            };

            const closeImageModal = () => {
                imageModal.classList.remove("show");
                setTimeout(() => {
                    imageModal.style.display = "none";
                    document.body.style.overflow = "auto";
                }, 300);
            };

            // Event Listeners
            loginForm.addEventListener("submit", (e) => {
                e.preventDefault();
                currentUser = usernameInput.value.trim();
                secretKey = secretKeyInput.value.trim();

                if (!currentUser || !secretKey) {
                    showError("Please enter both username and secret key");
                    return;
                }

                if (currentUser.length > 20) {
                    showError("Username too long (max 20 characters)");
                    return;
                }

                errorMessage.style.display = "none";
                initializeSocket();

                // Transition UI
                loginScreen.style.display = "none";
                chatContainer.style.display = "flex";
                messageInput.focus();
            });

            messageForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                updateActivity();

                if (pendingFiles.length > 0) {
                    await sendFiles();
                }

                const content = messageInput.value.trim();
                if (content && socket && socket.connected) {
                    sendMessage(content);
                    messageInput.value = "";
                    updateSendButton();
                }
            });

            messageInput.addEventListener("input", () => {
                updateSendButton();

                if (socket && socket.connected) {
                    clearTimeout(typingTimeout);
                    socket.emit("typing");
                    typingTimeout = setTimeout(() => {
                        socket.emit("stop_typing");
                    }, 2000);
                }
            });

            fileInput.addEventListener("change", (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files);
                }
            });

            fileInputBtn.addEventListener("click", () => {
                fileInput.click();
            });

            themeToggle.addEventListener("click", toggleTheme);

            exitSessionBtn.addEventListener("click", () => {
                if (socket && socket.connected) {
                    socket.disconnect();
                }
                window.open("", "_self", "");
                window.close();
                setTimeout(() => {
                    window.location.href = "about:blank";
                }, 500);
            });

            imageModalClose.addEventListener("click", closeImageModal);
            imageModal.addEventListener("click", (e) => {
                if (e.target === imageModal) {
                    closeImageModal();
                }
            });

            // Drag and drop file upload
            let dragCounter = 0;

            messagesContainer.addEventListener("dragenter", (e) => {
                e.preventDefault();
                dragCounter++;
                messagesContainer.style.backgroundColor =
                    "var(--imessage-light-gray)";
            });

            messagesContainer.addEventListener("dragleave", (e) => {
                e.preventDefault();
                dragCounter--;
                if (dragCounter === 0) {
                    messagesContainer.style.backgroundColor = "";
                }
            });

            messagesContainer.addEventListener("dragover", (e) => {
                e.preventDefault();
            });

            messagesContainer.addEventListener("drop", (e) => {
                e.preventDefault();
                dragCounter = 0;
                messagesContainer.style.backgroundColor = "";

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files);
                }
            });

            // Activity tracking
            ["click", "keypress", "mousemove", "touchstart"].forEach(
                (event) => {
                    document.addEventListener(event, updateActivity, {
                        passive: true,
                    });
                },
            );

            // Handle page visibility change
            document.addEventListener("visibilitychange", () => {
                if (!document.hidden && socket && socket.connected) {
                    updateActivity();
                }
            });

            // Request notification permission
            if (
                "Notification" in window &&
                Notification.permission === "default"
            ) {
                Notification.requestPermission();
            }

            // Keyboard shortcuts
            document.addEventListener("keydown", (e) => {
                // Escape to close modals
                if (e.key === "Escape") {
                    closeImageModal();
                    closePrivacyAlert();
                    document
                        .querySelectorAll(".reaction-picker.show")
                        .forEach((p) => {
                            p.classList.remove("show");
                        });
                }

                // Ctrl/Cmd + Enter to send message
                if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
                    if (messageInput.value.trim() || pendingFiles.length > 0) {
                        messageForm.dispatchEvent(new Event("submit"));
                    }
                }
            });

            // Initialize privacy protection
            detectScreenshot();
            detectScreenRecording();
            detectDevTools();
            detectCopyPaste();

            // Initialize UI
            updateSendButton();

            // Focus username input on load
            if (usernameInput) {
                usernameInput.focus();
            }

            // Handle online/offline status
            window.addEventListener("online", () => {
                if (socket && !socket.connected) {
                    socket.connect();
                }
            });

            window.addEventListener("offline", () => {
                updateConnectionStatus(false);
                addSystemMessage("Connection lost. You are now offline.");
            });

            // Global functions for onclick handlers
            window.openImageModal = openImageModal;
            window.addReaction = addReaction;
            window.removeFile = removeFile;
            window.closePrivacyAlert = closePrivacyAlert;

            console.log(
                "üöÄ Enhanced Secure Chatroom initialized successfully!",
            );
            console.log("üîí Privacy protection features active");
        </script>
    </body>
</html>
